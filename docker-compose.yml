version: '3.9'

networks:
  internal_net:
    driver: bridge
  public_net:
    driver: bridge

services:

  postgres:
    image: postgres:16-alpine
    container_name: postgres_cont
    environment:
      - POSTGRES_USER=lms_user
      - POSTGRES_PASSWORD=lms_pass
      - POSTGRES_DB=lms_db
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks:
      - internal_net
  
  redis:
    image: redis:7-alpine
    container_name: redis_cont
    command: ["redis-server", "--requirepass", "redis_pass"]
    volumes:
    - redisdata:/data
    networks:
    - internal_net

  mongo:
    image: mongo:7
    container_name: mongo_cont
    environment:
      - MONGO_INITDB_ROOT_USERNAME=mongoadmin
      - MONGO_INITDB_ROOT_PASSWORD=mongopass
    networks:
      - internal_net

#================kong Gateway================#

  kong:
    image: kong:3.7
    container_name: kong_gateway
    environment:
      - KONG_DATABASE=off
      - KONG_DECLARATIVE_CONFIG=/etc/kong/kong.yml
      - KONG_PROXY_LISTEN=0.0.0.0:8000
      - KONG_ADMIN_LISTEN=0.0.0.0:8001
    ports:
      - "8000:8000"
      - "8001:8001"
    volumes:
      - ./gateway/kong.yaml:/etc/kong/kong.yml
    networks:
      - internal_net

#================Ngnix================#

  nginx:
    image: nginx:alpine
    container_name: nginx_lb
    ports:
      - "8080:80"
      - "8443:443"
    volumes:
      - ./gateway/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - kong
    networks:
      - public_net
      - internal_net



#================LMS Services================#

  auth-service:
    build: ./services/auth-service
    container_name: auth_service
    environment:
      - PORT=4001
      - NODE_ENV=production
    expose:
      - "4001"
    depends_on:
      - postgres
      - redis
      - mongo
    networks:
      - internal_net
  


volumes:
  pgdata:
  redisdata:
  mongodata:


   

    
  