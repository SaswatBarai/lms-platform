_format_version: "3.0"
_transform: true

#---------------------------------------------------
# Services and Routes
#---------------------------------------------------

services:
  - name: auth-service
    url: http://auth-service:4001
    routes:
      - name: auth-service-routes
        paths:
          - "/auth/api/health"
          - "/auth/api/metrics"
          - "/auth/api/create-organization"
          - "/auth/api/verify-organization-otp"
          - "/auth/api/resend-organization-otp"
          - "/auth/api/login-organization"
          - "/auth/api/login-college"
          - "/auth/api/regenerate-access-token-organization"
          - "/auth/api/regenerate-access-token-college"
          - "/auth/api/forgot-password-organization"
          - "/auth/api/forgot-password-college"
          - "/auth/api/forgot-reset-password-college"
          - "/auth/api/reset-password-college"
          - "/auth/api/login-non-teaching-staff"  
          - "/auth/api/forgot-password-non-teaching-staff"
          - "/auth/api/reset-forgot-password-non-teaching-staff"
          - "/auth/api/regenerate-access-token-non-teaching-staff"
          - "/auth/api/login-hod"
          - "/auth/api/forgot-password-hod"
          - "/auth/api/forgot-reset-password-hod"
          - "/auth/api/login-student"
          - "/auth/api/regenerate-access-token-student"
          - "/auth/api/forgot-password-student"
          - "/auth/api/forgot-reset-password-student"
          - "/auth/api/login-teacher"
          - "/auth/api/forgot-password-teacher"
          - "/auth/api/forgot-reset-password-teacher"
        strip_path: false

      - name: auth-service-api-docs
        paths:
          - "~/auth/api/api-docs.*"
        strip_path: false
        preserve_host: true
        methods:
          - GET
        regex_priority: 10

      - name: auth-service-routes-protected
        paths:
          - "/auth/api/test-protected"
          - "/auth/api/create-college"
          - "/auth/api/logout-organization"
          - "/auth/api/logout-college"
          - "/auth/api/create-non-teaching-staff-bulk"
          - "/auth/api/reset-password-non-teaching-staff"
          - "/auth/api/reset-password-college"
          - "/auth/api/reset-password-organization"
          - "/auth/api/add-department" #later this will shift another service which is department service
          - "/auth/api/add-course"
          - "/auth/api/add-batch"
          - "/auth/api/add-section"
          - "/auth/api/create-student-bulk"
          - "/auth/api/create-teacher-bulk"
          - "/auth/api/create-hod"
          - "/auth/api/logout-hod"
          - "/auth/api/regenerate-access-token-hod"
          - "/auth/api/reset-password-hod"
          - "/auth/api/logout-student"
          - "/auth/api/reset-password-student"
          - "/auth/api/logout-teacher"
          - "/auth/api/regenerate-access-token-teacher"
          - "/auth/api/reset-password-teacher"
          - "/auth/api/student/me/session"
          - "/auth/api/student/me/logout-all"
          - "/auth/api/admin/force-logout"
        strip_path: false
        plugins:
          - name: paseto-vault-auth-lua
            config:
              vault_address: "http://vault:8200"
              vault_token: "dev-root-token"
              header_prefix: "X-User-"
              cache_timeout: 3600
              required_roles: []
              redis_host: "redis"
              redis_port: 6379
              redis_password: "redis_pass"
              redis_database: 0
              redis_timeout: 2000
              validate_session: true

      # Bulk Import Health Check (Public - No Auth Required)
      # Must be before protected routes to match first
      - name: auth-service-bulk-health
        paths:
          - "/auth/api/bulk/health"
        strip_path: false
        methods:
          - GET
        regex_priority: 20
        # No auth plugin - public endpoint

      # Bulk Import Routes (Protected)
      # POST /auth/api/bulk/upload - Upload file and create import job
      # POST /auth/api/bulk/validate - Validate file without importing
      # GET /auth/api/bulk/jobs - List all jobs for user
      - name: auth-service-bulk-import-routes
        paths:
          - "/auth/api/bulk/upload"
          - "/auth/api/bulk/validate"
          - "/auth/api/bulk/jobs"
        strip_path: false
        methods:
          - GET
          - POST
        plugins:
          - name: paseto-vault-auth-lua
            config:
              vault_address: "http://vault:8200"
              vault_token: "dev-root-token"
              header_prefix: "X-User-"
              cache_timeout: 3600
              required_roles: []
              redis_host: "redis"
              redis_port: 6379
              redis_password: "redis_pass"
              redis_database: 0
              redis_timeout: 2000
              validate_session: true

      # Bulk Import Job Routes (Protected) - Specific job operations
      # GET /auth/api/bulk/jobs/:jobId - Get job status
      # POST /auth/api/bulk/jobs/:jobId/rollback - Rollback job
      # GET /auth/api/bulk/jobs/:jobId/errors - Get error report URL
      - name: auth-service-bulk-job-routes
        paths:
          - "~/auth/api/bulk/jobs/[^/]+$"
          - "~/auth/api/bulk/jobs/[^/]+/rollback$"
          - "~/auth/api/bulk/jobs/[^/]+/errors$"
        strip_path: false
        regex_priority: 10
        methods:
          - GET
          - POST
        plugins:
          - name: paseto-vault-auth-lua
            config:
              vault_address: "http://vault:8200"
              vault_token: "dev-root-token"
              header_prefix: "X-User-"
              cache_timeout: 3600
              required_roles: []
              redis_host: "redis"
              redis_port: 6379
              redis_password: "redis_pass"
              redis_database: 0
              redis_timeout: 2000
              validate_session: true

      # API Keys Management Routes (Protected)
      # POST /auth/api/api-keys - Create new API key
      # GET /auth/api/api-keys - List user's API keys
      # DELETE /auth/api/api-keys/:id - Revoke an API key
      - name: auth-service-api-keys-routes
        paths:
          - "/auth/api/api-keys"
          - "~/auth/api/api-keys/[^/]+$"
        strip_path: false
        regex_priority: 10
        methods:
          - GET
          - POST
          - DELETE
        plugins:
          - name: paseto-vault-auth-lua
            config:
              vault_address: "http://vault:8200"
              vault_token: "dev-root-token"
              header_prefix: "X-User-"
              cache_timeout: 3600
              required_roles: []
              redis_host: "redis"
              redis_port: 6379
              redis_password: "redis_pass"
              redis_database: 0
              redis_timeout: 2000
              validate_session: true

#---------------------------------------------------
# Monitoring stack (Prometheus, Grafana, Jaeger, Kibana)
# Access via: http://localhost:8000/monitoring/<service>
#---------------------------------------------------

  - name: prometheus
    url: http://prometheus:9090
    routes:
      - name: prometheus-route
        paths:
          - "/monitoring/prometheus"
        strip_path: true

  - name: grafana
    url: http://grafana:3000
    routes:
      - name: grafana-route
        paths:
          - "/monitoring/grafana"
        strip_path: false
        preserve_host: true

  - name: jaeger
    url: http://jaeger:16686
    routes:
      - name: jaeger-route
        paths:
          - "/monitoring/jaeger"
        strip_path: true

  - name: kibana
    url: http://kibana:5601
    routes:
      - name: kibana-route
        paths:
          - "/monitoring/kibana"
        strip_path: true

#---------------------------------------------------
# Global Plugins (Phase 5 Enhancement)
#---------------------------------------------------
plugins:
  # 1. Rate Limiting: Prevent DDoS and spam requests
  - name: rate-limiting
    config:
      minute: 100
      hour: 1000
      policy: redis
      redis_host: "redis"
      redis_port: 6379
      redis_password: "redis_pass"
      redis_timeout: 2000

  # 2. Request Transformer: Automatically inject tracking IDs and API versions
  - name: request-transformer
    config:
      add:
        headers:
          - "X-API-Version: v1"
          - "X-Request-ID: $(uuid)" # Vital for Jaeger Tracing

  # 3. CORS: Secure cross-origin requests from the frontend
  - name: cors
    config:
      origins: 
        - "*" # Note: In production, change this to ["https://lms.example.com"]
      methods: 
        - GET
        - POST
        - PUT
        - PATCH
        - DELETE
      headers: 
        - Authorization
        - Content-Type
        - x-api-key # Allow the new API keys through!
      max_age: 3600

  # 4. Proxy Cache: Cache frequent GET requests to save database load
  - name: proxy-cache
    config:
      strategy: memory
      content_type: ["application/json"]
      cache_ttl: 300 # 5 minutes
      request_method: ["GET"] # Only cache GET requests!

  # 5. Kafka Log: Stream all gateway access logs directly to Kafka for Analytics
  - name: kafka-log
    config:
      bootstrap_servers:
        - host: kafka
          port: 9092
      topic: gateway.access.logs
      keepalive: 60000
      producer_request_acks: 1 # Wait for leader acknowledgement
      producer_request_timeout: 2000

